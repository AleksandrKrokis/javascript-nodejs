style.

  /* выбор оплаты - только для новых заказов или для неудавшейся оплаты */
  .pay-chooser {
    display: none;
  }
  form.pay-form[data-new="1"] .pay-chooser {
    display: block;
  }
  form.pay-form[data-payment-state="fail"] .pay-chooser {
    display: block;
  }

  /* индикатор загрузки - только для существующих заказов без статуса оплаты */
  .pay-loading {
    display: none;
  }

  form.pay-form[data-new="0"]:not([data-payment-state]) .pay-loading {
    display: block;
  }

  /* результат оплаты (должен быть над .pay-chooser) - только когда он есть */
  .pay-result {
    display: none;
  }

  form.pay-form[data-payment-state] .pay-result {
    display: block;
  }


script var csrf = "#{csrf}", orderNumber;


div

  form.pay-form(data-new=(order.isNew ? "1" : "0"))
    input(type="text" name="orderNumber" value=(!order.isNew && order.number) placeholder="order number")
    input(type="text" name="orderTemplate" value=orderTemplate)

    fieldset
      legend  Описание книги и стоимость
      h2= order.title
      div= order.description
      div #{order.amount} р.

    fieldset

      legend  Укажите свой email (если не авторизован)

      input(name="email" value=order.email placeholder="E-mail" disabled=!order.isNew)
    fieldset
      legend Оплата или результат оплаты

      div.pay-result Загружаем информацию...

      //- показываем выбор оплаты только если заказ новый, иначе пока прячем и ждём, нужно ли
      div.pay-info
        p Выберите способ оплаты:
          select(name="paymentMethod")
            each paymentMethod in paymentMethods
              option(value=paymentMethod.name) #{paymentMethod.title}
            input(type="submit" value="Оплатить")



script(src="http://code.jquery.com/jquery-2.1.1.js")

script.
  var payForm = $('.pay-form');
  var payResult = $('.pay-result');
  if (payResult.length) {
    var requestPayResultStart = new Date();
    requestPayResult();
  }
  payForm.on('submit', onPayFormSubmit);
  function requestPayResult() {
    if (new Date() - requestPayResultStart > 120e3) { // 2 mins
      payResult.html("Таймаут ответа от платёжной системы. Попробуйте обновить эту страницу позже или обратиться в <a href=\"mailto:help@javascript.ru\">поддержку</a>.");
      return;
    }

    $.ajax({
      method: 'GET',
      url: '/getpdf/pay-result/' + payForm[0].elements.orderNumber.value,
      data: {
       orderNumber: payForm[0].elements.orderNumber.value
      }
    })
    .done(function(result) {
      if (!result) {
        setTimeout(requestPayResult, 1000);
        return;
      }
      showPayResult(result);
    })
    .fail(function(err) {
      setTimeout(requestPayResult, 1000);
    });
  }

  function showPayResult(result) {
    payForm.addClass(result.status);
    payResult.html(result.html);
  }

  function onPayFormSubmit(e) {
    e.preventDefault();
    $.ajax({
      method: 'POST',
      url: '/getpdf/checkout',
      data: {
        _csrf: csrf,
        orderNumber: this.elements.orderNumber.value,
        orderTemplate: this.elements.orderTemplate.value,
        email: this.elements.email.value,
        paymentMethod: this.elements.paymentMethod.value
      }
    })
    .fail(function(err) {
      alert("Ошибка на сервере");
    })
    .done(function(htmlForm) {
      $(htmlForm).submit();
    });
  }
