{"version":3,"sources":["webpack:///ebook.f72ef463adde7a467a48.js","webpack:///./handlers/ebook/client/index.js","webpack:///./handlers/ebook/client/orderForm.js","webpack:///./handlers/tutorial/client/ebook.js","webpack:///./client/xhr.js","webpack:///./client/getCsrfCookie.js"],"names":["ebook","webpackJsonp_name_","module","exports","__webpack_require__","OrderForm","init","orderForm","document","querySelector","elem",31,"_createClass","defineProperties","target","props","key","prop","configurable","value","writable","Object","Constructor","protoProps","staticProps","prototype","_classCallCheck","instance","TypeError","xhr","notification","delegate","Spinner","options","_this","this","addEventListener","e","preventDefault","onPaymentMethodClick","style","display","data","paymentMethod","delegateTarget","window","orderNumber","chooser","orderTemplate","amount","dataset","elements","email","ga","metrika","reachGoal","product","Error","focus","request","method","url","normalStatuses","body","id","variant","price","quantity","step","option","onEnd","startRequestIndication","event","status","result","description","message","form","container","createElement","hidden","innerHTML","appendChild","hitCallback","firstChild","submit","number","_request","_requestWrapper","apply","arguments","toString","bind","paymentMethodElem","classList","add","spinner","size","class","start","remove","stop","delegateMixin",34,"relinkToHeaders","internalLinks","querySelectorAll","i","length","link","getElementById","getAttribute","setAttribute","replaceSlashesInFragments","replace","elems",35,"sendStat","name","toUpperCase","time","Date","now","timeStart","String","wrapEvent","CustomEvent","originalEvent","fail","reason","dispatchEvent","success","XMLHttpRequest","open","sync","csrfCookie","getCsrfCookie","skipCsrf","setRequestHeader","call","JSON","stringify","type","raw","indexOf","responseText","contentType","getResponseHeader","match","json","parse","setTimeout","send",38,"cookie"],"mappings":"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","file":"ebook.f72ef463adde7a467a48.js","sourcesContent":["var ebook =\nwebpackJsonp_name_([1],{\n\n/***/ 0:\n/***/ function(module, exports, __webpack_require__) {\n\n\t\"use strict\";\n\t\n\tvar OrderForm = __webpack_require__(31);\n\t\n\texports.init = function () {\n\t\n\t  var orderForm = document.querySelector(\"[data-order-form]\");\n\t  if (orderForm) {\n\t    new OrderForm({\n\t      elem: orderForm\n\t    });\n\t  }\n\t};\n\n/***/ },\n\n/***/ 31:\n/***/ function(module, exports, __webpack_require__) {\n\n\t\"use strict\";\n\t\n\tvar _createClass = (function () { function defineProperties(target, props) { for (var key in props) { var prop = props[key]; prop.configurable = true; if (prop.value) prop.writable = true; } Object.defineProperties(target, props); } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; })();\n\t\n\tvar _classCallCheck = function (instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError(\"Cannot call a class as a function\"); } };\n\t\n\tvar xhr = __webpack_require__(35);\n\tvar notification = __webpack_require__(23);\n\tvar delegate = __webpack_require__(36);\n\tvar Spinner = __webpack_require__(37);\n\t\n\tvar OrderForm = (function () {\n\t  function OrderForm(options) {\n\t    var _this = this;\n\t\n\t    _classCallCheck(this, OrderForm);\n\t\n\t    this.elem = options.elem;\n\t\n\t    this.elem.addEventListener(\"submit\", function (e) {\n\t      return e.preventDefault();\n\t    });\n\t\n\t    // many buttons with paymentMethods, onSubmit doesn't give a way to learn which one is pressed\n\t    // so I listen to onclick\n\t    this.delegate(\"[name=\\\"paymentMethod\\\"]\", \"click\", function (e) {\n\t      return _this.onPaymentMethodClick(e);\n\t    });\n\t\n\t    this.delegate(\"[data-order-payment-change]\", \"click\", function (e) {\n\t      e.preventDefault();\n\t      this.elem.querySelector(\"[data-order-form-step-payment]\").style.display = \"block\";\n\t      this.elem.querySelector(\"[data-order-form-step-confirm]\").style.display = \"none\";\n\t      this.elem.querySelector(\"[data-order-form-step-receipt]\").style.display = \"none\";\n\t    });\n\t  }\n\t\n\t  _createClass(OrderForm, {\n\t    onPaymentMethodClick: {\n\t      value: function onPaymentMethodClick(e) {\n\t\n\t        var data = {\n\t          paymentMethod: e.delegateTarget.value\n\t        };\n\t\n\t        if (window.orderNumber) {\n\t          data.orderNumber = window.orderNumber;\n\t        } else {\n\t          var chooser = this.elem.querySelector(\"input[name=\\\"orderTemplate\\\"]:checked\");\n\t          data.orderTemplate = chooser.value;\n\t          data.amount = chooser.dataset.amount; // for stats\n\t        }\n\t\n\t        if (this.elem.elements.email) {\n\t          if (!this.elem.elements.email.value) {\n\t            window.ga(\"send\", \"event\", \"payment\", \"checkout-no-email\", \"ebook\");\n\t            window.metrika.reachGoal(\"CHECKOUT-NO-EMAIL\", { product: \"ebook\" });\n\t            new notification.Error(\"Введите email.\");\n\t            this.elem.elements.email.focus();\n\t            return;\n\t          } else {\n\t            data.email = this.elem.elements.email.value;\n\t          }\n\t        }\n\t\n\t        // response status must be 200\n\t        var request = xhr({\n\t          method: \"POST\",\n\t          url: \"/payments/common/checkout\",\n\t          normalStatuses: [200, 403],\n\t          body: data\n\t        });\n\t\n\t        if (data.orderTemplate) {\n\t          window.ga(\"ec:addProduct\", {\n\t            id: \"ebook\",\n\t            variant: data.orderTemplate,\n\t            price: data.amount,\n\t            quantity: 1\n\t          });\n\t        }\n\t\n\t        window.ga(\"ec:setAction\", \"checkout\", {\n\t          step: 1,\n\t          option: data.paymentMethod\n\t        });\n\t\n\t        window.metrika.reachGoal(\"CHECKOUT\", {\n\t          product: \"ebook\",\n\t          method: data.paymentMethod,\n\t          price: data.amount\n\t        });\n\t\n\t        window.ga(\"send\", \"event\", \"payment\", \"checkout\", \"ebook\");\n\t        window.ga(\"send\", \"event\", \"payment\", \"checkout-method-\" + data.paymentMethod, \"ebook\");\n\t\n\t        var onEnd = this.startRequestIndication();\n\t\n\t        request.addEventListener(\"success\", function (event) {\n\t\n\t          if (this.status == 403) {\n\t            new notification.Error(\"<p>\" + (event.result.description || event.result.message) + \"</p><p>Пожалуйста, начните оформление заново.</p><p>Если вы считаете, что на сервере ошибка &mdash; свяжитесь со <a href='mailto:orders@javascript.ru'>службой поддержки</a>.</p>\");\n\t            onEnd();\n\t            return;\n\t          }\n\t\n\t          var result = event.result;\n\t\n\t          if (result.form) {\n\t            // don't stop the spinner while submitting the form to the payment system!\n\t            // (still in progress)\n\t\n\t            window.ga(\"ec:setAction\", \"purchase\", {\n\t              id: result.orderNumber\n\t            });\n\t\n\t            var container = document.createElement(\"div\");\n\t            container.hidden = true;\n\t            container.innerHTML = result.form;\n\t            document.body.appendChild(container);\n\t\n\t            window.ga(\"send\", \"event\", \"payment\", \"purchase\", \"ebook\", {\n\t              hitCallback: function hitCallback() {\n\t                container.firstChild.submit();\n\t              }\n\t            });\n\t\n\t            window.metrika.reachGoal(\"PURCHASE\", {\n\t              product: \"ebook\",\n\t              method: data.paymentMethod,\n\t              price: data.amount,\n\t              number: result.orderNumber\n\t            });\n\t          } else {\n\t            console.error(result);\n\t            onEnd();\n\t            new notification.Error(\"Ошибка на сервере, свяжитесь со <a href='mailto:orders@javascript.ru'>службой поддержки</a>.\");\n\t          }\n\t        });\n\t\n\t        request.addEventListener(\"fail\", onEnd);\n\t      }\n\t    },\n\t    request: {\n\t      value: (function (_request) {\n\t        var _requestWrapper = function request(_x) {\n\t          return _request.apply(this, arguments);\n\t        };\n\t\n\t        _requestWrapper.toString = function () {\n\t          return _request.toString();\n\t        };\n\t\n\t        return _requestWrapper;\n\t      })(function (options) {\n\t        var request = xhr(options);\n\t\n\t        request.addEventListener(\"loadstart\", (function () {\n\t          var onEnd = this.startRequestIndication();\n\t          request.addEventListener(\"loadend\", onEnd);\n\t        }).bind(this));\n\t\n\t        return request;\n\t      })\n\t    },\n\t    startRequestIndication: {\n\t      value: function startRequestIndication() {\n\t\n\t        var paymentMethodElem = this.elem.querySelector(\".pay-method\");\n\t        paymentMethodElem.classList.add(\"modal-overlay_light\");\n\t\n\t        var spinner = new Spinner({\n\t          elem: paymentMethodElem,\n\t          size: \"medium\",\n\t          \"class\": \"pay-method__spinner\"\n\t        });\n\t        spinner.start();\n\t\n\t        return function onEnd() {\n\t          paymentMethodElem.classList.remove(\"modal-overlay_light\");\n\t          if (spinner) spinner.stop();\n\t        };\n\t      }\n\t    }\n\t  });\n\t\n\t  return OrderForm;\n\t})();\n\t\n\tdelegate.delegateMixin(OrderForm.prototype);\n\t\n\tmodule.exports = OrderForm;\n\n/***/ },\n\n/***/ 34:\n/***/ function(module, exports, __webpack_require__) {\n\n\t\"use strict\";\n\t\n\texports.init = function () {\n\t\n\t  relinkToHeaders();\n\t\n\t  replaceSlashesInFragments();\n\t};\n\t\n\t// Internal links like /object\n\t// In Ebook article headers get id=url, e.g h2(id=/object)\n\t// Task headers also get similar urls\n\t//   a(href=/object) should go to a(href=#/object) (if exists)\n\tfunction relinkToHeaders() {\n\t\n\t  var internalLinks = document.querySelectorAll(\"a[href^=\\\"/\\\"]\");\n\t\n\t  for (var i = 0; i < internalLinks.length; i++) {\n\t    var link = internalLinks[i];\n\t    if (document.getElementById(link.getAttribute(\"href\"))) {\n\t      link.setAttribute(\"href\", \"#\" + link.getAttribute(\"href\"));\n\t    }\n\t  }\n\t}\n\t\n\t// quick fix for ebook-converter issue\n\t// http://www.mobileread.com/forums/showthread.php?p=3044812#post3044812\n\t// contrary to http://tools.ietf.org/html/rfc3986\n\t// forbids / in fragments https://github.com/kovidgoyal/calibre/blob/ef09e886b3d95d6de5c76ad3a179694ae75c65f4/src/calibre/ebooks/conversion/plugins/epub_output.py#L350-L359\n\tfunction replaceSlashesInFragments() {\n\t\n\t  var internalLinks = document.querySelectorAll(\"a[href^=\\\"#\\\"]\");\n\t\n\t  for (var i = 0; i < internalLinks.length; i++) {\n\t    var link = internalLinks[i];\n\t    link.setAttribute(\"href\", link.getAttribute(\"href\").replace(/\\//g, \"-\"));\n\t  }\n\t\n\t  var elems = document.querySelectorAll(\"[id]\");\n\t\n\t  for (var i = 0; i < elems.length; i++) {\n\t    var elem = elems[i];\n\t    elem.id = elem.id.replace(/\\//g, \"-\");\n\t  }\n\t}\n\n/***/ },\n\n/***/ 35:\n/***/ function(module, exports, __webpack_require__) {\n\n\t\"use strict\";\n\t\n\tvar notification = __webpack_require__(23);\n\tvar getCsrfCookie = __webpack_require__(38);\n\t// Wrapper about XHR\n\t// # Global Events\n\t// triggers document.loadstart/loadend on communication start/end\n\t//    --> unless options.noGlobalEvents is set\n\t//\n\t// # Events\n\t// triggers fail/success on load end:\n\t//    --> by default status=200 is ok, the others are failures\n\t//    --> options.normalStatuses = [201,409] allow given statuses\n\t//    --> fail event has .reason field\n\t//    --> success event has .result field\n\t//\n\t// # JSON\n\t//    --> send(object) calls JSON.stringify\n\t//    --> adds Accept: json (we want json) by default, unless options.raw\n\t// if options.json or server returned json content type\n\t//    --> autoparse json\n\t//    --> fail if error\n\t//\n\t// # CSRF\n\t//    --> requests sends header X-XSRF-TOKEN from cookie\n\t\n\tfunction xhr(options) {\n\t\n\t  var request = new XMLHttpRequest();\n\t\n\t  var method = options.method || \"GET\";\n\t\n\t  var body = options.body;\n\t  var url = options.url;\n\t\n\t  request.open(method, url, options.sync ? false : true);\n\t\n\t  request.method = method;\n\t\n\t  // token/header names same as angular $http for easier interop\n\t  var csrfCookie = getCsrfCookie();\n\t  if (csrfCookie && !options.skipCsrf) {\n\t    request.setRequestHeader(\"X-XSRF-TOKEN\", csrfCookie);\n\t  }\n\t\n\t  if (({}).toString.call(body) == \"[object Object]\") {\n\t    // must be OPENed to setRequestHeader\n\t    request.setRequestHeader(\"Content-Type\", \"application/json;charset=UTF-8\");\n\t    body = JSON.stringify(body);\n\t  }\n\t\n\t  request.addEventListener(\"loadstart\", function (event) {\n\t    request.timeStart = Date.now();\n\t    sendStat(event.type);\n\t    var e = wrapEvent(\"xhrstart\", event);\n\t    document.dispatchEvent(e);\n\t  });\n\t  request.addEventListener(\"loadend\", function (event) {\n\t    sendStat(event.type);\n\t    var e = wrapEvent(\"xhrend\", event);\n\t    document.dispatchEvent(e);\n\t  });\n\t  request.addEventListener(\"success\", function (event) {\n\t    sendStat(event.type);\n\t    var e = wrapEvent(\"xhrsuccess\", event);\n\t    e.result = event.result;\n\t    document.dispatchEvent(e);\n\t  });\n\t  request.addEventListener(\"fail\", function (event) {\n\t    sendStat(event.type);\n\t    var e = wrapEvent(\"xhrfail\", event);\n\t    e.reason = event.reason;\n\t    document.dispatchEvent(e);\n\t  });\n\t\n\t  if (!options.raw) {\n\t    // means we want json\n\t    request.setRequestHeader(\"Accept\", \"application/json\");\n\t  }\n\t\n\t  request.setRequestHeader(\"X-Requested-With\", \"XMLHttpRequest\");\n\t\n\t  var normalStatuses = options.normalStatuses || [200];\n\t\n\t  function sendStat(name) {\n\t    window.metrika.reachGoal(\"XHR-\" + name.toUpperCase(), {\n\t      time: Date.now() - request.timeStart,\n\t      method: request.method,\n\t      url: request.url,\n\t      status: String(request.status)\n\t    });\n\t  }\n\t\n\t  function wrapEvent(name, e) {\n\t    var event = new CustomEvent(name);\n\t    event.originalEvent = e;\n\t    return event;\n\t  }\n\t\n\t  function fail(reason, originalEvent) {\n\t    var e = wrapEvent(\"fail\", originalEvent);\n\t    e.reason = reason;\n\t    request.dispatchEvent(e);\n\t  }\n\t\n\t  function success(result, originalEvent) {\n\t    var e = wrapEvent(\"success\", originalEvent);\n\t    e.result = result;\n\t    request.dispatchEvent(e);\n\t  }\n\t\n\t  request.addEventListener(\"error\", function (e) {\n\t    fail(\"Ошибка связи с сервером.\", e);\n\t  });\n\t\n\t  request.addEventListener(\"timeout\", function (e) {\n\t    fail(\"Превышено максимально допустимое время ожидания ответа от сервера.\", e);\n\t  });\n\t\n\t  request.addEventListener(\"abort\", function (e) {\n\t    fail(\"Запрос был прерван.\", e);\n\t  });\n\t\n\t  request.addEventListener(\"load\", function (e) {\n\t    if (!request.status) {\n\t      // does that ever happen?\n\t      fail(\"Не получен ответ от сервера.\", e);\n\t      return;\n\t    }\n\t\n\t    if (normalStatuses.indexOf(request.status) == -1) {\n\t      fail(\"Ошибка на стороне сервера (код \" + request.status + \"), попытайтесь позднее\", e);\n\t      return;\n\t    }\n\t\n\t    var result = request.responseText;\n\t    var contentType = request.getResponseHeader(\"Content-Type\");\n\t    if (contentType.match(/^application\\/json/) || options.json) {\n\t      // autoparse json if WANT or RECEIVED json\n\t      try {\n\t        result = JSON.parse(result);\n\t      } catch (e) {\n\t        fail(\"Некорректный формат ответа от сервера\", e);\n\t        return;\n\t      }\n\t    }\n\t\n\t    success(result, e);\n\t  });\n\t\n\t  // defer to let other handlers be assigned\n\t  setTimeout(function () {\n\t    request.send(body);\n\t  }, 0);\n\t\n\t  return request;\n\t}\n\t\n\tfunction addUrlParam(url, name, value) {\n\t  var param = encodeURIComponent(name) + \"=\" + encodeURIComponent(value);\n\t  if (~url.indexOf(\"?\")) {\n\t    return url + \"&\" + param;\n\t  } else {\n\t    return url + \"?\" + param;\n\t  }\n\t}\n\t\n\tdocument.addEventListener(\"xhrfail\", function (event) {\n\t  new notification.Error(event.reason);\n\t});\n\t\n\tmodule.exports = xhr;\n\n/***/ },\n\n/***/ 38:\n/***/ function(module, exports, __webpack_require__) {\n\n\t\"use strict\";\n\t\n\tmodule.exports = function () {\n\t  var csrfCookie = document.cookie.match(/XSRF-TOKEN=([\\w-]+)/);\n\t  return csrfCookie ? csrfCookie[1] : null;\n\t};\n\n/***/ }\n\n});\n\n\n/** WEBPACK FOOTER **\n ** ebook.f72ef463adde7a467a48.js\n **/","var OrderForm = require('./orderForm');\n\nexports.init = function() {\n\n\n  var orderForm = document.querySelector('[data-order-form]');\n  if (orderForm) {\n    new OrderForm({\n      elem: orderForm\n    });\n  }\n\n};\n\n\n/** WEBPACK FOOTER **\n ** ./handlers/ebook/client/index.js\n **/","var xhr = require('client/xhr');\nvar notification = require('client/notification');\nvar delegate = require('client/delegate');\nvar Spinner = require('client/spinner');\n\n\nclass OrderForm {\n\n\n  constructor(options) {\n    this.elem = options.elem;\n\n    this.elem.addEventListener('submit', (e) => e.preventDefault());\n\n    // many buttons with paymentMethods, onSubmit doesn't give a way to learn which one is pressed\n    // so I listen to onclick\n    this.delegate('[name=\"paymentMethod\"]', 'click', (e) => this.onPaymentMethodClick(e));\n\n    this.delegate('[data-order-payment-change]', 'click', function(e) {\n      e.preventDefault();\n      this.elem.querySelector('[data-order-form-step-payment]').style.display = 'block';\n      this.elem.querySelector('[data-order-form-step-confirm]').style.display = 'none';\n      this.elem.querySelector('[data-order-form-step-receipt]').style.display = 'none';\n    });\n  }\n\n  onPaymentMethodClick(e) {\n\n    var data = {\n      paymentMethod: e.delegateTarget.value\n    };\n\n    if (window.orderNumber) {\n      data.orderNumber = window.orderNumber;\n    } else {\n      var chooser = this.elem.querySelector('input[name=\"orderTemplate\"]:checked');\n      data.orderTemplate = chooser.value;\n      data.amount = chooser.dataset.amount; // for stats\n    }\n\n    if (this.elem.elements.email) {\n      if (!this.elem.elements.email.value) {\n        window.ga('send', 'event', 'payment', 'checkout-no-email', 'ebook');\n        window.metrika.reachGoal('CHECKOUT-NO-EMAIL', { product: 'ebook'});\n        new notification.Error(\"Введите email.\");\n        this.elem.elements.email.focus();\n        return;\n      } else {\n        data.email = this.elem.elements.email.value;\n      }\n    }\n\n    // response status must be 200\n    var request = xhr({\n      method:         'POST',\n      url:            '/payments/common/checkout',\n      normalStatuses: [200, 403],\n      body:           data\n    });\n\n    if (data.orderTemplate) {\n      window.ga('ec:addProduct', {\n        id:       'ebook',\n        variant:  data.orderTemplate,\n        price:    data.amount,\n        quantity: 1\n      });\n    }\n\n    window.ga('ec:setAction', 'checkout', {\n      step: 1,\n      option: data.paymentMethod\n    });\n\n    window.metrika.reachGoal('CHECKOUT', {\n      product: 'ebook',\n      method:  data.paymentMethod,\n      price: data.amount\n    });\n\n    window.ga('send', 'event', 'payment', 'checkout', 'ebook');\n    window.ga('send', 'event', 'payment', 'checkout-method-' + data.paymentMethod, 'ebook');\n\n    var onEnd = this.startRequestIndication();\n\n    request.addEventListener('success', function(event) {\n\n      if (this.status == 403) {\n        new notification.Error(\"<p>\" + (event.result.description || event.result.message) + \"</p><p>Пожалуйста, начните оформление заново.</p><p>Если вы считаете, что на сервере ошибка &mdash; свяжитесь со <a href='mailto:orders@javascript.ru'>службой поддержки</a>.</p>\");\n        onEnd();\n        return;\n      }\n\n      var result = event.result;\n\n      if (result.form) {\n        // don't stop the spinner while submitting the form to the payment system!\n        // (still in progress)\n\n        window.ga('ec:setAction', 'purchase', {\n          id: result.orderNumber\n        });\n\n        var container = document.createElement('div');\n        container.hidden = true;\n        container.innerHTML = result.form;\n        document.body.appendChild(container);\n\n        window.ga('send', 'event', 'payment', 'purchase', 'ebook', {\n          hitCallback: function() {\n            container.firstChild.submit();\n          }\n        });\n\n\n        window.metrika.reachGoal('PURCHASE', {\n          product: 'ebook',\n          method:  data.paymentMethod,\n          price: data.amount,\n          number: result.orderNumber\n        });\n\n\n      } else {\n        console.error(result);\n        onEnd();\n        new notification.Error(\"Ошибка на сервере, свяжитесь со <a href='mailto:orders@javascript.ru'>службой поддержки</a>.\");\n      }\n    });\n\n    request.addEventListener('fail', onEnd);\n  }\n\n\n  request(options) {\n    var request = xhr(options);\n\n    request.addEventListener('loadstart', function() {\n      var onEnd = this.startRequestIndication();\n      request.addEventListener('loadend', onEnd);\n    }.bind(this));\n\n    return request;\n  }\n\n  startRequestIndication() {\n\n    var paymentMethodElem = this.elem.querySelector('.pay-method');\n    paymentMethodElem.classList.add('modal-overlay_light');\n\n    var spinner = new Spinner({\n      elem:  paymentMethodElem,\n      size:  'medium',\n      class: 'pay-method__spinner'\n    });\n    spinner.start();\n\n    return function onEnd() {\n      paymentMethodElem.classList.remove('modal-overlay_light');\n      if (spinner) spinner.stop();\n    };\n\n  }\n\n\n}\n\n\ndelegate.delegateMixin(OrderForm.prototype);\n\nmodule.exports = OrderForm;\n\n\n\n/** WEBPACK FOOTER **\n ** ./handlers/ebook/client/orderForm.js\n **/","exports.init = function() {\n\n  relinkToHeaders();\n\n  replaceSlashesInFragments();\n\n};\n\n// Internal links like /object\n// In Ebook article headers get id=url, e.g h2(id=/object)\n// Task headers also get similar urls\n//   a(href=/object) should go to a(href=#/object) (if exists)\nfunction relinkToHeaders() {\n\n  var internalLinks = document.querySelectorAll('a[href^=\"/\"]');\n\n  for (var i = 0; i < internalLinks.length; i++) {\n    var link = internalLinks[i];\n    if (document.getElementById(link.getAttribute('href'))) {\n      link.setAttribute('href', '#' + link.getAttribute('href'));\n    }\n  }\n\n}\n\n// quick fix for ebook-converter issue\n// http://www.mobileread.com/forums/showthread.php?p=3044812#post3044812\n// contrary to http://tools.ietf.org/html/rfc3986\n// forbids / in fragments https://github.com/kovidgoyal/calibre/blob/ef09e886b3d95d6de5c76ad3a179694ae75c65f4/src/calibre/ebooks/conversion/plugins/epub_output.py#L350-L359\nfunction replaceSlashesInFragments() {\n\n  var internalLinks = document.querySelectorAll('a[href^=\"#\"]');\n\n  for (var i = 0; i < internalLinks.length; i++) {\n    var link = internalLinks[i];\n    link.setAttribute('href', link.getAttribute('href').replace(/\\//g, '-'));\n  }\n\n  var elems =  document.querySelectorAll('[id]');\n\n  for (var i = 0; i < elems.length; i++) {\n    var elem = elems[i];\n    elem.id = elem.id.replace(/\\//g, '-');\n  }\n\n\n}\n\n\n/** WEBPACK FOOTER **\n ** ./handlers/tutorial/client/ebook.js\n **/","var notification = require('client/notification');\nvar getCsrfCookie = require('client/getCsrfCookie');\n// Wrapper about XHR\n// # Global Events\n// triggers document.loadstart/loadend on communication start/end\n//    --> unless options.noGlobalEvents is set\n//\n// # Events\n// triggers fail/success on load end:\n//    --> by default status=200 is ok, the others are failures\n//    --> options.normalStatuses = [201,409] allow given statuses\n//    --> fail event has .reason field\n//    --> success event has .result field\n//\n// # JSON\n//    --> send(object) calls JSON.stringify\n//    --> adds Accept: json (we want json) by default, unless options.raw\n// if options.json or server returned json content type\n//    --> autoparse json\n//    --> fail if error\n//\n// # CSRF\n//    --> requests sends header X-XSRF-TOKEN from cookie\n\nfunction xhr(options) {\n\n  var request = new XMLHttpRequest();\n\n  var method = options.method || 'GET';\n\n  var body = options.body;\n  var url = options.url;\n\n  request.open(method, url, options.sync ? false : true);\n\n  request.method = method;\n\n  // token/header names same as angular $http for easier interop\n  var csrfCookie = getCsrfCookie();\n  if (csrfCookie && !options.skipCsrf) {\n    request.setRequestHeader(\"X-XSRF-TOKEN\", csrfCookie);\n  }\n\n  if ({}.toString.call(body) == '[object Object]') {\n    // must be OPENed to setRequestHeader\n    request.setRequestHeader(\"Content-Type\", \"application/json;charset=UTF-8\");\n    body = JSON.stringify(body);\n  }\n\n\n  request.addEventListener('loadstart', event => {\n    request.timeStart = Date.now();\n    sendStat(event.type);\n    var e = wrapEvent('xhrstart', event);\n    document.dispatchEvent(e);\n  });\n  request.addEventListener('loadend', event => {\n    sendStat(event.type);\n    var e = wrapEvent('xhrend', event);\n    document.dispatchEvent(e);\n  });\n  request.addEventListener('success', event => {\n    sendStat(event.type);\n    var e = wrapEvent('xhrsuccess', event);\n    e.result = event.result;\n    document.dispatchEvent(e);\n  });\n  request.addEventListener('fail', event => {\n    sendStat(event.type);\n    var e = wrapEvent('xhrfail', event);\n    e.reason = event.reason;\n    document.dispatchEvent(e);\n  });\n\n  if (!options.raw) { // means we want json\n    request.setRequestHeader(\"Accept\", \"application/json\");\n  }\n\n  request.setRequestHeader('X-Requested-With', \"XMLHttpRequest\");\n\n  var normalStatuses = options.normalStatuses || [200];\n\n  function sendStat(name) {\n    window.metrika.reachGoal('XHR-' + name.toUpperCase(), {\n      time: Date.now() - request.timeStart,\n      method: request.method,\n      url: request.url,\n      status: String(request.status)\n    });\n  }\n\n  function wrapEvent(name, e) {\n    var event = new CustomEvent(name);\n    event.originalEvent = e;\n    return event;\n  }\n\n  function fail(reason, originalEvent) {\n    var e = wrapEvent(\"fail\", originalEvent);\n    e.reason = reason;\n    request.dispatchEvent(e);\n  }\n\n  function success(result, originalEvent) {\n    var e = wrapEvent(\"success\", originalEvent);\n    e.result = result;\n    request.dispatchEvent(e);\n  }\n\n  request.addEventListener(\"error\", e => {\n    fail(\"Ошибка связи с сервером.\", e);\n  });\n\n  request.addEventListener(\"timeout\", e => {\n    fail(\"Превышено максимально допустимое время ожидания ответа от сервера.\", e);\n  });\n\n  request.addEventListener(\"abort\", e => {\n    fail(\"Запрос был прерван.\", e);\n  });\n\n  request.addEventListener(\"load\", e => {\n    if (!request.status) { // does that ever happen?\n      fail(\"Не получен ответ от сервера.\", e);\n      return;\n    }\n\n    if (normalStatuses.indexOf(request.status) == -1) {\n      fail(\"Ошибка на стороне сервера (код \" + request.status + \"), попытайтесь позднее\", e);\n      return;\n    }\n\n    var result = request.responseText;\n    var contentType = request.getResponseHeader(\"Content-Type\");\n    if (contentType.match(/^application\\/json/) || options.json) { // autoparse json if WANT or RECEIVED json\n      try {\n        result = JSON.parse(result);\n      } catch (e) {\n        fail(\"Некорректный формат ответа от сервера\", e);\n        return;\n      }\n    }\n\n    success(result, e);\n  });\n\n  // defer to let other handlers be assigned\n  setTimeout(function() {\n    request.send(body);\n  }, 0);\n\n\n\n\n  return request;\n\n}\n\nfunction addUrlParam(url, name, value) {\n  var param = encodeURIComponent(name) + '=' + encodeURIComponent(value);\n  if (~url.indexOf('?')) {\n    return url + '&' + param;\n  } else {\n    return url + '?' + param;\n  }\n\n}\n\ndocument.addEventListener('xhrfail', function(event) {\n  new notification.Error(event.reason);\n});\n\n\nmodule.exports = xhr;\n\n\n\n/** WEBPACK FOOTER **\n ** ./client/xhr.js\n **/","module.exports = function() {\n  var csrfCookie = document.cookie.match(/XSRF-TOKEN=([\\w-]+)/);\n  return csrfCookie ? csrfCookie[1] : null;\n};\n\n\n\n\n/** WEBPACK FOOTER **\n ** ./client/getCsrfCookie.js\n **/"],"sourceRoot":""}