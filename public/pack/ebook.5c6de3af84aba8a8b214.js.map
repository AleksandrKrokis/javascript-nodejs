{"version":3,"sources":["webpack:///ebook.5c6de3af84aba8a8b214.js","webpack:///./handlers/ebook/client/index.js","webpack:///./handlers/ebook/client/orderForm.js","webpack:///./client/xhr.js","webpack:///./client/getCsrfCookie.js","webpack:///./handlers/tutorial/client/ebook.js"],"names":["ebook","webpackJsonp_name_","module","exports","__webpack_require__","OrderForm","init","orderForm","document","querySelector","elem",32,"_classCallCheck","instance","Constructor","TypeError","_createClass","defineProperties","target","props","i","length","descriptor","enumerable","configurable","writable","Object","defineProperty","key","protoProps","staticProps","prototype","xhr","notification","delegate","Spinner","options","_this","this","addEventListener","e","preventDefault","onPaymentMethodClick","style","display","value","data","paymentMethod","delegateTarget","window","orderNumber","chooser","orderTemplate","amount","dataset","elements","email","ga","metrika","reachGoal","product","Error","focus","request","method","url","normalStatuses","body","id","variant","price","quantity","step","option","onEnd","startRequestIndication","event","status","result","description","message","form","container","createElement","hidden","innerHTML","appendChild","submitForm","_submitForm","apply","arguments","toString","called","firstChild","submit","hitCallback","setTimeout","number","_request","bind","paymentMethodElem","classList","add","spinner","size","class","start","remove","stop","delegateMixin",34,"wrapEvent","name","CustomEvent","originalEvent","fail","reason","dispatchEvent","success","XMLHttpRequest","open","sync","csrfCookie","getCsrfCookie","skipCsrf","setRequestHeader","call","JSON","stringify","timeStart","Date","now","raw","indexOf","responseText","contentType","getResponseHeader","match","json","parse","send",35,"cookie",39,"relinkToHeaders","internalLinks","querySelectorAll","link","getElementById","getAttribute","setAttribute","replaceSlashesInFragments","replace","elems"],"mappings":"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","file":"ebook.5c6de3af84aba8a8b214.js","sourcesContent":["var ebook =\nwebpackJsonp_name_([1],{\n\n/***/ 0:\n/***/ function(module, exports, __webpack_require__) {\n\n\t'use strict';\n\t\n\tvar OrderForm = __webpack_require__(32);\n\t\n\texports.init = function () {\n\t\n\t  var orderForm = document.querySelector('[data-order-form]');\n\t  if (orderForm) {\n\t    new OrderForm({\n\t      elem: orderForm\n\t    });\n\t  }\n\t};\n\n/***/ },\n\n/***/ 32:\n/***/ function(module, exports, __webpack_require__) {\n\n\t'use strict';\n\t\n\tvar _classCallCheck = function (instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError('Cannot call a class as a function'); } };\n\t\n\tvar _createClass = (function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ('value' in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; })();\n\t\n\tvar xhr = __webpack_require__(34);\n\tvar notification = __webpack_require__(23);\n\tvar delegate = __webpack_require__(40);\n\tvar Spinner = __webpack_require__(33);\n\t\n\tvar OrderForm = (function () {\n\t  function OrderForm(options) {\n\t    var _this = this;\n\t\n\t    _classCallCheck(this, OrderForm);\n\t\n\t    this.elem = options.elem;\n\t\n\t    this.elem.addEventListener('submit', function (e) {\n\t      return e.preventDefault();\n\t    });\n\t\n\t    // many buttons with paymentMethods, onSubmit doesn't give a way to learn which one is pressed\n\t    // so I listen to onclick\n\t    this.delegate('[name=\"paymentMethod\"]', 'click', function (e) {\n\t      return _this.onPaymentMethodClick(e);\n\t    });\n\t\n\t    this.delegate('[data-order-payment-change]', 'click', function (e) {\n\t      e.preventDefault();\n\t      this.elem.querySelector('[data-order-form-step-payment]').style.display = 'block';\n\t      this.elem.querySelector('[data-order-form-step-confirm]').style.display = 'none';\n\t      this.elem.querySelector('[data-order-form-step-receipt]').style.display = 'none';\n\t    });\n\t  }\n\t\n\t  _createClass(OrderForm, [{\n\t    key: 'onPaymentMethodClick',\n\t    value: function onPaymentMethodClick(e) {\n\t\n\t      var data = {\n\t        paymentMethod: e.delegateTarget.value\n\t      };\n\t\n\t      if (window.orderNumber) {\n\t        data.orderNumber = window.orderNumber;\n\t      } else {\n\t        var chooser = this.elem.querySelector('input[name=\"orderTemplate\"]:checked');\n\t        data.orderTemplate = chooser.value;\n\t        data.amount = chooser.dataset.amount; // for stats\n\t      }\n\t\n\t      if (this.elem.elements.email) {\n\t        if (!this.elem.elements.email.value) {\n\t          window.ga('send', 'event', 'payment', 'checkout-no-email', 'ebook');\n\t          window.metrika.reachGoal('CHECKOUT-NO-EMAIL', { product: 'ebook' });\n\t          new notification.Error('Введите email.');\n\t          this.elem.elements.email.focus();\n\t          return;\n\t        } else {\n\t          data.email = this.elem.elements.email.value;\n\t        }\n\t      }\n\t\n\t      // response status must be 200\n\t      var request = xhr({\n\t        method: 'POST',\n\t        url: '/payments/common/checkout',\n\t        normalStatuses: [200, 403],\n\t        body: data\n\t      });\n\t\n\t      if (data.orderTemplate) {\n\t        window.ga('ec:addProduct', {\n\t          id: 'ebook',\n\t          variant: data.orderTemplate,\n\t          price: data.amount,\n\t          quantity: 1\n\t        });\n\t      }\n\t\n\t      window.ga('ec:setAction', 'checkout', {\n\t        step: 1,\n\t        option: data.paymentMethod\n\t      });\n\t\n\t      window.metrika.reachGoal('CHECKOUT', {\n\t        product: 'ebook',\n\t        method: data.paymentMethod,\n\t        price: data.amount\n\t      });\n\t\n\t      window.ga('send', 'event', 'payment', 'checkout', 'ebook');\n\t      window.ga('send', 'event', 'payment', 'checkout-method-' + data.paymentMethod, 'ebook');\n\t\n\t      var onEnd = this.startRequestIndication();\n\t\n\t      request.addEventListener('success', function (event) {\n\t\n\t        if (this.status == 403) {\n\t          new notification.Error('<p>' + (event.result.description || event.result.message) + '</p><p>Пожалуйста, начните оформление заново.</p><p>Если вы считаете, что на сервере ошибка &mdash; свяжитесь со <a href=\\'mailto:orders@javascript.ru\\'>службой поддержки</a>.</p>');\n\t          onEnd();\n\t          return;\n\t        }\n\t\n\t        var result = event.result;\n\t\n\t        if (result.form) {\n\t          // don't stop the spinner while submitting the form to the payment system!\n\t          // (still in progress)\n\t\n\t          window.ga('ec:setAction', 'purchase', {\n\t            id: result.orderNumber\n\t          });\n\t\n\t          var container = document.createElement('div');\n\t          container.hidden = true;\n\t          container.innerHTML = result.form;\n\t          document.body.appendChild(container);\n\t\n\t          // submit form after GA or after 500ms, which one comes sooner\n\t          var submitForm = (function (_submitForm) {\n\t            function submitForm() {\n\t              return _submitForm.apply(this, arguments);\n\t            }\n\t\n\t            submitForm.toString = function () {\n\t              return _submitForm.toString();\n\t            };\n\t\n\t            return submitForm;\n\t          })(function () {\n\t            if (!submitForm.called) {\n\t              submitForm.called = true;\n\t              container.firstChild.submit();\n\t            }\n\t          });\n\t\n\t          window.ga('send', 'event', 'payment', 'purchase', 'ebook', {\n\t            hitCallback: submitForm\n\t          });\n\t          setTimeout(submitForm, 500);\n\t\n\t          window.metrika.reachGoal('PURCHASE', {\n\t            product: 'ebook',\n\t            method: data.paymentMethod,\n\t            price: data.amount,\n\t            number: result.orderNumber\n\t          });\n\t        } else {\n\t          console.error(result);\n\t          onEnd();\n\t          new notification.Error('Ошибка на сервере, свяжитесь со <a href=\\'mailto:orders@javascript.ru\\'>службой поддержки</a>.');\n\t        }\n\t      });\n\t\n\t      request.addEventListener('fail', onEnd);\n\t    }\n\t  }, {\n\t    key: 'request',\n\t    value: (function (_request) {\n\t      function request(_x) {\n\t        return _request.apply(this, arguments);\n\t      }\n\t\n\t      request.toString = function () {\n\t        return _request.toString();\n\t      };\n\t\n\t      return request;\n\t    })(function (options) {\n\t      var request = xhr(options);\n\t\n\t      request.addEventListener('loadstart', (function () {\n\t        var onEnd = this.startRequestIndication();\n\t        request.addEventListener('loadend', onEnd);\n\t      }).bind(this));\n\t\n\t      return request;\n\t    })\n\t  }, {\n\t    key: 'startRequestIndication',\n\t    value: function startRequestIndication() {\n\t\n\t      var paymentMethodElem = this.elem.querySelector('.pay-method');\n\t      paymentMethodElem.classList.add('modal-overlay_light');\n\t\n\t      var spinner = new Spinner({\n\t        elem: paymentMethodElem,\n\t        size: 'medium',\n\t        'class': 'pay-method__spinner'\n\t      });\n\t      spinner.start();\n\t\n\t      return function onEnd() {\n\t        paymentMethodElem.classList.remove('modal-overlay_light');\n\t        if (spinner) spinner.stop();\n\t      };\n\t    }\n\t  }]);\n\t\n\t  return OrderForm;\n\t})();\n\t\n\tdelegate.delegateMixin(OrderForm.prototype);\n\t\n\tmodule.exports = OrderForm;\n\n/***/ },\n\n/***/ 34:\n/***/ function(module, exports, __webpack_require__) {\n\n\t'use strict';\n\t\n\tvar notification = __webpack_require__(23);\n\tvar getCsrfCookie = __webpack_require__(35);\n\t// Wrapper about XHR\n\t// # Global Events\n\t// triggers document.loadstart/loadend on communication start/end\n\t//    --> unless options.noGlobalEvents is set\n\t//\n\t// # Events\n\t// triggers fail/success on load end:\n\t//    --> by default status=200 is ok, the others are failures\n\t//    --> options.normalStatuses = [201,409] allow given statuses\n\t//    --> fail event has .reason field\n\t//    --> success event has .result field\n\t//\n\t// # JSON\n\t//    --> send(object) calls JSON.stringify\n\t//    --> adds Accept: json (we want json) by default, unless options.raw\n\t// if options.json or server returned json content type\n\t//    --> autoparse json\n\t//    --> fail if error\n\t//\n\t// # CSRF\n\t//    --> requests sends header X-XSRF-TOKEN from cookie\n\t\n\tfunction xhr(options) {\n\t\n\t  var request = new XMLHttpRequest();\n\t\n\t  var method = options.method || 'GET';\n\t\n\t  var body = options.body;\n\t  var url = options.url;\n\t\n\t  request.open(method, url, options.sync ? false : true);\n\t\n\t  request.method = method;\n\t\n\t  // token/header names same as angular $http for easier interop\n\t  var csrfCookie = getCsrfCookie();\n\t  if (csrfCookie && !options.skipCsrf) {\n\t    request.setRequestHeader('X-XSRF-TOKEN', csrfCookie);\n\t  }\n\t\n\t  if (({}).toString.call(body) == '[object Object]') {\n\t    // must be OPENed to setRequestHeader\n\t    request.setRequestHeader('Content-Type', 'application/json;charset=UTF-8');\n\t    body = JSON.stringify(body);\n\t  }\n\t\n\t  request.addEventListener('loadstart', function (event) {\n\t    request.timeStart = Date.now();\n\t    var e = wrapEvent('xhrstart', event);\n\t    document.dispatchEvent(e);\n\t  });\n\t  request.addEventListener('loadend', function (event) {\n\t    var e = wrapEvent('xhrend', event);\n\t    document.dispatchEvent(e);\n\t  });\n\t  request.addEventListener('success', function (event) {\n\t    var e = wrapEvent('xhrsuccess', event);\n\t    e.result = event.result;\n\t    document.dispatchEvent(e);\n\t  });\n\t  request.addEventListener('fail', function (event) {\n\t    var e = wrapEvent('xhrfail', event);\n\t    e.reason = event.reason;\n\t    document.dispatchEvent(e);\n\t  });\n\t\n\t  if (!options.raw) {\n\t    // means we want json\n\t    request.setRequestHeader('Accept', 'application/json');\n\t  }\n\t\n\t  request.setRequestHeader('X-Requested-With', 'XMLHttpRequest');\n\t\n\t  var normalStatuses = options.normalStatuses || [200];\n\t\n\t  function wrapEvent(name, e) {\n\t    var event = new CustomEvent(name);\n\t    event.originalEvent = e;\n\t    return event;\n\t  }\n\t\n\t  function fail(reason, originalEvent) {\n\t    var e = wrapEvent('fail', originalEvent);\n\t    e.reason = reason;\n\t    request.dispatchEvent(e);\n\t  }\n\t\n\t  function success(result, originalEvent) {\n\t    var e = wrapEvent('success', originalEvent);\n\t    e.result = result;\n\t    request.dispatchEvent(e);\n\t  }\n\t\n\t  request.addEventListener('error', function (e) {\n\t    fail('Ошибка связи с сервером.', e);\n\t  });\n\t\n\t  request.addEventListener('timeout', function (e) {\n\t    fail('Превышено максимально допустимое время ожидания ответа от сервера.', e);\n\t  });\n\t\n\t  request.addEventListener('abort', function (e) {\n\t    fail('Запрос был прерван.', e);\n\t  });\n\t\n\t  request.addEventListener('load', function (e) {\n\t    if (!request.status) {\n\t      // does that ever happen?\n\t      fail('Не получен ответ от сервера.', e);\n\t      return;\n\t    }\n\t\n\t    if (normalStatuses.indexOf(request.status) == -1) {\n\t      fail('Ошибка на стороне сервера (код ' + request.status + '), попытайтесь позднее', e);\n\t      return;\n\t    }\n\t\n\t    var result = request.responseText;\n\t    var contentType = request.getResponseHeader('Content-Type');\n\t    if (contentType.match(/^application\\/json/) || options.json) {\n\t      // autoparse json if WANT or RECEIVED json\n\t      try {\n\t        result = JSON.parse(result);\n\t      } catch (e) {\n\t        fail('Некорректный формат ответа от сервера', e);\n\t        return;\n\t      }\n\t    }\n\t\n\t    success(result, e);\n\t  });\n\t\n\t  // defer to let other handlers be assigned\n\t  setTimeout(function () {\n\t    request.send(body);\n\t  }, 0);\n\t\n\t  return request;\n\t}\n\t\n\tfunction addUrlParam(url, name, value) {\n\t  var param = encodeURIComponent(name) + '=' + encodeURIComponent(value);\n\t  if (~url.indexOf('?')) {\n\t    return url + '&' + param;\n\t  } else {\n\t    return url + '?' + param;\n\t  }\n\t}\n\t\n\tdocument.addEventListener('xhrfail', function (event) {\n\t  new notification.Error(event.reason);\n\t});\n\t\n\tmodule.exports = xhr;\n\n/***/ },\n\n/***/ 35:\n/***/ function(module, exports, __webpack_require__) {\n\n\t\"use strict\";\n\t\n\tmodule.exports = function () {\n\t  var csrfCookie = document.cookie.match(/XSRF-TOKEN=([\\w-]+)/);\n\t  return csrfCookie ? csrfCookie[1] : null;\n\t};\n\n/***/ },\n\n/***/ 39:\n/***/ function(module, exports, __webpack_require__) {\n\n\t'use strict';\n\t\n\texports.init = function () {\n\t\n\t  relinkToHeaders();\n\t\n\t  replaceSlashesInFragments();\n\t};\n\t\n\t// Internal links like /object\n\t// In Ebook article headers get id=url, e.g h2(id=/object)\n\t// Task headers also get similar urls\n\t//   a(href=/object) should go to a(href=#/object) (if exists)\n\tfunction relinkToHeaders() {\n\t\n\t  var internalLinks = document.querySelectorAll('a[href^=\"/\"]');\n\t\n\t  for (var i = 0; i < internalLinks.length; i++) {\n\t    var link = internalLinks[i];\n\t    if (document.getElementById(link.getAttribute('href'))) {\n\t      link.setAttribute('href', '#' + link.getAttribute('href'));\n\t    }\n\t  }\n\t}\n\t\n\t// quick fix for ebook-converter issue\n\t// http://www.mobileread.com/forums/showthread.php?p=3044812#post3044812\n\t// contrary to http://tools.ietf.org/html/rfc3986\n\t// forbids / in fragments https://github.com/kovidgoyal/calibre/blob/ef09e886b3d95d6de5c76ad3a179694ae75c65f4/src/calibre/ebooks/conversion/plugins/epub_output.py#L350-L359\n\tfunction replaceSlashesInFragments() {\n\t\n\t  var internalLinks = document.querySelectorAll('a[href^=\"#\"]');\n\t\n\t  for (var i = 0; i < internalLinks.length; i++) {\n\t    var link = internalLinks[i];\n\t    link.setAttribute('href', link.getAttribute('href').replace(/\\//g, '-'));\n\t  }\n\t\n\t  var elems = document.querySelectorAll('[id]');\n\t\n\t  for (var i = 0; i < elems.length; i++) {\n\t    var elem = elems[i];\n\t    elem.id = elem.id.replace(/\\//g, '-');\n\t  }\n\t}\n\n/***/ }\n\n});\n\n\n/** WEBPACK FOOTER **\n ** ebook.5c6de3af84aba8a8b214.js\n **/","var OrderForm = require('./orderForm');\n\nexports.init = function() {\n\n\n  var orderForm = document.querySelector('[data-order-form]');\n  if (orderForm) {\n    new OrderForm({\n      elem: orderForm\n    });\n  }\n\n};\n\n\n/** WEBPACK FOOTER **\n ** ./handlers/ebook/client/index.js\n **/","var xhr = require('client/xhr');\nvar notification = require('client/notification');\nvar delegate = require('client/delegate');\nvar Spinner = require('client/spinner');\n\n\nclass OrderForm {\n\n\n  constructor(options) {\n    this.elem = options.elem;\n\n    this.elem.addEventListener('submit', (e) => e.preventDefault());\n\n    // many buttons with paymentMethods, onSubmit doesn't give a way to learn which one is pressed\n    // so I listen to onclick\n    this.delegate('[name=\"paymentMethod\"]', 'click', (e) => this.onPaymentMethodClick(e));\n\n    this.delegate('[data-order-payment-change]', 'click', function(e) {\n      e.preventDefault();\n      this.elem.querySelector('[data-order-form-step-payment]').style.display = 'block';\n      this.elem.querySelector('[data-order-form-step-confirm]').style.display = 'none';\n      this.elem.querySelector('[data-order-form-step-receipt]').style.display = 'none';\n    });\n  }\n\n  onPaymentMethodClick(e) {\n\n    var data = {\n      paymentMethod: e.delegateTarget.value\n    };\n\n    if (window.orderNumber) {\n      data.orderNumber = window.orderNumber;\n    } else {\n      var chooser = this.elem.querySelector('input[name=\"orderTemplate\"]:checked');\n      data.orderTemplate = chooser.value;\n      data.amount = chooser.dataset.amount; // for stats\n    }\n\n    if (this.elem.elements.email) {\n      if (!this.elem.elements.email.value) {\n        window.ga('send', 'event', 'payment', 'checkout-no-email', 'ebook');\n        window.metrika.reachGoal('CHECKOUT-NO-EMAIL', { product: 'ebook'});\n        new notification.Error(\"Введите email.\");\n        this.elem.elements.email.focus();\n        return;\n      } else {\n        data.email = this.elem.elements.email.value;\n      }\n    }\n\n    // response status must be 200\n    var request = xhr({\n      method:         'POST',\n      url:            '/payments/common/checkout',\n      normalStatuses: [200, 403],\n      body:           data\n    });\n\n    if (data.orderTemplate) {\n      window.ga('ec:addProduct', {\n        id:       'ebook',\n        variant:  data.orderTemplate,\n        price:    data.amount,\n        quantity: 1\n      });\n    }\n\n    window.ga('ec:setAction', 'checkout', {\n      step: 1,\n      option: data.paymentMethod\n    });\n\n    window.metrika.reachGoal('CHECKOUT', {\n      product: 'ebook',\n      method:  data.paymentMethod,\n      price: data.amount\n    });\n\n    window.ga('send', 'event', 'payment', 'checkout', 'ebook');\n    window.ga('send', 'event', 'payment', 'checkout-method-' + data.paymentMethod, 'ebook');\n\n    var onEnd = this.startRequestIndication();\n\n    request.addEventListener('success', function(event) {\n\n      if (this.status == 403) {\n        new notification.Error(\"<p>\" + (event.result.description || event.result.message) + \"</p><p>Пожалуйста, начните оформление заново.</p><p>Если вы считаете, что на сервере ошибка &mdash; свяжитесь со <a href='mailto:orders@javascript.ru'>службой поддержки</a>.</p>\");\n        onEnd();\n        return;\n      }\n\n      var result = event.result;\n\n      if (result.form) {\n        // don't stop the spinner while submitting the form to the payment system!\n        // (still in progress)\n\n        window.ga('ec:setAction', 'purchase', {\n          id: result.orderNumber\n        });\n\n        var container = document.createElement('div');\n        container.hidden = true;\n        container.innerHTML = result.form;\n        document.body.appendChild(container);\n\n\n        // submit form after GA or after 500ms, which one comes sooner\n        var submitForm = function() {\n          if (!submitForm.called) {\n            submitForm.called = true;\n            container.firstChild.submit();\n          }\n        };\n\n        window.ga('send', 'event', 'payment', 'purchase', 'ebook', {\n          hitCallback: submitForm\n        });\n        setTimeout(submitForm, 500);\n\n\n        window.metrika.reachGoal('PURCHASE', {\n          product: 'ebook',\n          method:  data.paymentMethod,\n          price: data.amount,\n          number: result.orderNumber\n        });\n\n\n      } else {\n        console.error(result);\n        onEnd();\n        new notification.Error(\"Ошибка на сервере, свяжитесь со <a href='mailto:orders@javascript.ru'>службой поддержки</a>.\");\n      }\n    });\n\n    request.addEventListener('fail', onEnd);\n  }\n\n\n  request(options) {\n    var request = xhr(options);\n\n    request.addEventListener('loadstart', function() {\n      var onEnd = this.startRequestIndication();\n      request.addEventListener('loadend', onEnd);\n    }.bind(this));\n\n    return request;\n  }\n\n  startRequestIndication() {\n\n    var paymentMethodElem = this.elem.querySelector('.pay-method');\n    paymentMethodElem.classList.add('modal-overlay_light');\n\n    var spinner = new Spinner({\n      elem:  paymentMethodElem,\n      size:  'medium',\n      class: 'pay-method__spinner'\n    });\n    spinner.start();\n\n    return function onEnd() {\n      paymentMethodElem.classList.remove('modal-overlay_light');\n      if (spinner) spinner.stop();\n    };\n\n  }\n\n\n}\n\n\ndelegate.delegateMixin(OrderForm.prototype);\n\nmodule.exports = OrderForm;\n\n\n\n/** WEBPACK FOOTER **\n ** ./handlers/ebook/client/orderForm.js\n **/","var notification = require('client/notification');\nvar getCsrfCookie = require('client/getCsrfCookie');\n// Wrapper about XHR\n// # Global Events\n// triggers document.loadstart/loadend on communication start/end\n//    --> unless options.noGlobalEvents is set\n//\n// # Events\n// triggers fail/success on load end:\n//    --> by default status=200 is ok, the others are failures\n//    --> options.normalStatuses = [201,409] allow given statuses\n//    --> fail event has .reason field\n//    --> success event has .result field\n//\n// # JSON\n//    --> send(object) calls JSON.stringify\n//    --> adds Accept: json (we want json) by default, unless options.raw\n// if options.json or server returned json content type\n//    --> autoparse json\n//    --> fail if error\n//\n// # CSRF\n//    --> requests sends header X-XSRF-TOKEN from cookie\n\nfunction xhr(options) {\n\n  var request = new XMLHttpRequest();\n\n  var method = options.method || 'GET';\n\n  var body = options.body;\n  var url = options.url;\n\n  request.open(method, url, options.sync ? false : true);\n\n  request.method = method;\n\n  // token/header names same as angular $http for easier interop\n  var csrfCookie = getCsrfCookie();\n  if (csrfCookie && !options.skipCsrf) {\n    request.setRequestHeader(\"X-XSRF-TOKEN\", csrfCookie);\n  }\n\n  if ({}.toString.call(body) == '[object Object]') {\n    // must be OPENed to setRequestHeader\n    request.setRequestHeader(\"Content-Type\", \"application/json;charset=UTF-8\");\n    body = JSON.stringify(body);\n  }\n\n\n  request.addEventListener('loadstart', event => {\n    request.timeStart = Date.now();\n    var e = wrapEvent('xhrstart', event);\n    document.dispatchEvent(e);\n  });\n  request.addEventListener('loadend', event => {\n    var e = wrapEvent('xhrend', event);\n    document.dispatchEvent(e);\n  });\n  request.addEventListener('success', event => {\n    var e = wrapEvent('xhrsuccess', event);\n    e.result = event.result;\n    document.dispatchEvent(e);\n  });\n  request.addEventListener('fail', event => {\n    var e = wrapEvent('xhrfail', event);\n    e.reason = event.reason;\n    document.dispatchEvent(e);\n  });\n\n  if (!options.raw) { // means we want json\n    request.setRequestHeader(\"Accept\", \"application/json\");\n  }\n\n  request.setRequestHeader('X-Requested-With', \"XMLHttpRequest\");\n\n  var normalStatuses = options.normalStatuses || [200];\n\n  function wrapEvent(name, e) {\n    var event = new CustomEvent(name);\n    event.originalEvent = e;\n    return event;\n  }\n\n  function fail(reason, originalEvent) {\n    var e = wrapEvent(\"fail\", originalEvent);\n    e.reason = reason;\n    request.dispatchEvent(e);\n  }\n\n  function success(result, originalEvent) {\n    var e = wrapEvent(\"success\", originalEvent);\n    e.result = result;\n    request.dispatchEvent(e);\n  }\n\n  request.addEventListener(\"error\", e => {\n    fail(\"Ошибка связи с сервером.\", e);\n  });\n\n  request.addEventListener(\"timeout\", e => {\n    fail(\"Превышено максимально допустимое время ожидания ответа от сервера.\", e);\n  });\n\n  request.addEventListener(\"abort\", e => {\n    fail(\"Запрос был прерван.\", e);\n  });\n\n  request.addEventListener(\"load\", e => {\n    if (!request.status) { // does that ever happen?\n      fail(\"Не получен ответ от сервера.\", e);\n      return;\n    }\n\n    if (normalStatuses.indexOf(request.status) == -1) {\n      fail(\"Ошибка на стороне сервера (код \" + request.status + \"), попытайтесь позднее\", e);\n      return;\n    }\n\n    var result = request.responseText;\n    var contentType = request.getResponseHeader(\"Content-Type\");\n    if (contentType.match(/^application\\/json/) || options.json) { // autoparse json if WANT or RECEIVED json\n      try {\n        result = JSON.parse(result);\n      } catch (e) {\n        fail(\"Некорректный формат ответа от сервера\", e);\n        return;\n      }\n    }\n\n    success(result, e);\n  });\n\n  // defer to let other handlers be assigned\n  setTimeout(function() {\n    request.send(body);\n  }, 0);\n\n\n\n\n  return request;\n\n}\n\nfunction addUrlParam(url, name, value) {\n  var param = encodeURIComponent(name) + '=' + encodeURIComponent(value);\n  if (~url.indexOf('?')) {\n    return url + '&' + param;\n  } else {\n    return url + '?' + param;\n  }\n\n}\n\ndocument.addEventListener('xhrfail', function(event) {\n  new notification.Error(event.reason);\n});\n\n\nmodule.exports = xhr;\n\n\n\n/** WEBPACK FOOTER **\n ** ./client/xhr.js\n **/","module.exports = function() {\n  var csrfCookie = document.cookie.match(/XSRF-TOKEN=([\\w-]+)/);\n  return csrfCookie ? csrfCookie[1] : null;\n};\n\n\n\n\n/** WEBPACK FOOTER **\n ** ./client/getCsrfCookie.js\n **/","exports.init = function() {\n\n  relinkToHeaders();\n\n  replaceSlashesInFragments();\n\n};\n\n// Internal links like /object\n// In Ebook article headers get id=url, e.g h2(id=/object)\n// Task headers also get similar urls\n//   a(href=/object) should go to a(href=#/object) (if exists)\nfunction relinkToHeaders() {\n\n  var internalLinks = document.querySelectorAll('a[href^=\"/\"]');\n\n  for (var i = 0; i < internalLinks.length; i++) {\n    var link = internalLinks[i];\n    if (document.getElementById(link.getAttribute('href'))) {\n      link.setAttribute('href', '#' + link.getAttribute('href'));\n    }\n  }\n\n}\n\n// quick fix for ebook-converter issue\n// http://www.mobileread.com/forums/showthread.php?p=3044812#post3044812\n// contrary to http://tools.ietf.org/html/rfc3986\n// forbids / in fragments https://github.com/kovidgoyal/calibre/blob/ef09e886b3d95d6de5c76ad3a179694ae75c65f4/src/calibre/ebooks/conversion/plugins/epub_output.py#L350-L359\nfunction replaceSlashesInFragments() {\n\n  var internalLinks = document.querySelectorAll('a[href^=\"#\"]');\n\n  for (var i = 0; i < internalLinks.length; i++) {\n    var link = internalLinks[i];\n    link.setAttribute('href', link.getAttribute('href').replace(/\\//g, '-'));\n  }\n\n  var elems =  document.querySelectorAll('[id]');\n\n  for (var i = 0; i < elems.length; i++) {\n    var elem = elems[i];\n    elem.id = elem.id.replace(/\\//g, '-');\n  }\n\n\n}\n\n\n/** WEBPACK FOOTER **\n ** ./handlers/tutorial/client/ebook.js\n **/"],"sourceRoot":""}