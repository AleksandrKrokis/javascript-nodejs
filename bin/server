#!/usr/bin/env node

const config = require('config');
const co = require('co');
const app = require('app');

co(function*() {

  yield* app.waitBootAndListen();

  console.log("DONE");

})(function(err) {
  console.log("ERROR", err, err.stack);
  if (err) throw err;
});

process.on('message', function(msg) {
  if (msg == 'shutdown') { // PM2 sends this on graceful reload
    // The process is going to be reloaded
    // Have to close all database/socket.io/* connections

    co(function*() {
      yield app.close();
    })(function(err) {
      if (err) {
        console.error(err);
      }
      process.exit(0);
    });

    // I have 4000ms to close all connections
    setTimeout(function() {
      console.error("App stopping is taking too long!");
    }, 3500);

  }
});
